---
name: Release

on:
  push:
    branches:
      - main

concurrency: ${{ github.workflow }}-${{ github.ref }}

permissions:
  contents: write
  pull-requests: write

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Run CI checks
        uses: ./.github/actions/ci-checks
        with:
          node-version: 20.x

      - name: Create Release Pull Request or Publish
        id: changesets
        uses: changesets/action@e0145edc7d9d8679003495b11f87bd8ef63c0cba # v1.5.3
        with:
          title: 'ðŸš€ Release Preview'
          commit: 'chore: release'
          publish: pnpm exec changeset tag
          createGithubReleases: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Draft Release
        if: steps.changesets.outputs.published == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=${{ fromJson(steps.changesets.outputs.publishedPackages)[0].version }}
          TAG="v$VERSION"
          echo "Creating draft release for $TAG"
          gh release create "$TAG" \
            --draft \
            --title "$TAG" \
            --generate-notes

      - name: Update Major Tag
        if: steps.changesets.outputs.published == 'true'
        run: |
          git config user.name github-actions[bot]
          git config user.email 41898282+github-actions[bot]@users.noreply.github.com
          VERSION=${{ fromJson(steps.changesets.outputs.publishedPackages)[0].version }}
          MAJOR_VERSION=$(echo "$VERSION" | cut -d. -f1)
          if [ ! -z "$MAJOR_VERSION" ]; then
            git tag -fa "v$MAJOR_VERSION" -m "Update v$MAJOR_VERSION to $VERSION"
            git push origin "v$MAJOR_VERSION" --force
          fi
