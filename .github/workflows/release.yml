---
name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: read
  actions: read

jobs:
  prepare-release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${{ github.ref_name }}"
          fi
          echo "version=${VERSION#v}" >> $GITHUB_OUTPUT
          echo "tag=${VERSION}" >> $GITHUB_OUTPUT

  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x, 20.x, 22.x]

    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build TypeScript
        run: pnpm run build

      - name: Run type checking
        run: pnpm run typecheck

      - name: Run linter
        run: pnpm run lint

      - name: Run tests
        run: pnpm test

  validate-actions:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Validate GitHub Actions with actionlint
        uses: raven-actions/actionlint@789059c543ab20522fb3e7240794e13b0f69ad67 # v1.0.3
        with:
          files: |
            .github/workflows/*.yml
            deploy/action.yml
            comment/action.yml
            cleanup/action.yml

  create-release:
    runs-on: ubuntu-latest
    needs: [prepare-release, test, validate-actions]
    environment: production
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
        with:
          fetch-depth: 0

      - name: Load production secrets from 1Password
        id: load-secrets
        uses: ./.github/actions/load-1password-secrets
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm run build

      - name: Generate changelog
        id: changelog
        run: |
          # Simple changelog generation from git log
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            LAST_TAG=$(git rev-list --max-parents=0 HEAD)
          fi
          CHANGELOG=$(git log --pretty=format:"- %s" $LAST_TAG..HEAD)
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="- Initial release"
          fi
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@6cbd405e2c4e67a21c47fa9e383d020e4e28b836 # v2.3.3
        with:
          tag_name: ${{ needs.prepare-release.outputs.tag }}
          name: Cloudflare Actions ${{ needs.prepare-release.outputs.tag }}
          body: |
            ## ðŸš€ Cloudflare Actions ${{ needs.prepare-release.outputs.tag }}

            **GitHub Actions suite for Cloudflare Workers deployment.**

            ### ðŸ“¦ What's Included:
            - **Deploy Action**: Deploy Workers with preview environments
            - **Comment Action**: PR comment integration with deployment URLs
            - **Cleanup Action**: Automatic cleanup of old preview workers

            ### ðŸ”„ Changes:
            ${{ steps.changelog.outputs.changelog }}

            ### ðŸŽ¯ Usage:
            ```yaml
            - uses: harunonsystem/cloudflare-actions/deploy@TAG
              with:
                cloudflare-api-token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
                cloudflare-account-id: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
            ```

            ### ðŸ“š Documentation:
            - [README](README.md)
            - [Contributing](CONTRIBUTING.md)
            - [Changelog](CHANGELOG.md)
          draft: false
          prerelease: false
          generate_release_notes: true

  publish-marketplace:
    runs-on: ubuntu-latest
    needs: [prepare-release, create-release]
    if: startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, '-')
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Publish to GitHub Actions Marketplace
        run: |
          echo "ðŸŽ‰ Ready for GitHub Actions Marketplace!"
          echo "ðŸ“‹ Manual steps required:"
          echo "1. Go to releases/tag/${{ needs.prepare-release.outputs.tag }}"
          echo "2. Click 'Publish this Action to the GitHub Marketplace'"
          echo "3. Configure marketplace listing"
          echo "4. Submit for review"
