---
name: E2E Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

# Cancel in-progress runs for the same branch
concurrency:
  group: e2e-${{ github.ref }}
  cancel-in-progress: true

jobs:
  e2e-preview-deploy:
    name: E2E - Preview Deploy
    runs-on: ubuntu-latest
    # Only run if secrets are available (not from forks)
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Load secrets
        id: load-secrets
        uses: ./.github/actions/load-secrets
        with:
          op-service-account-token: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}

      - name: Setup
        uses: ./.github/actions/setup
        with:
          node-version: '20'

      - name: Build actions
        run: pnpm build

      # Test prepare-preview-deploy action
      - name: Prepare Preview Deploy
        id: prepare
        uses: ./prepare-preview-deploy
        with:
          worker-name: 'cf-actions-e2e-pr-{pr-number}'
          environment: preview
          domain: harunonsystem.workers.dev
          wrangler-toml-path: ./e2e/wrangler.toml

      - name: Verify prepare outputs
        run: |
          echo "Deployment URL: ${{ steps.prepare.outputs.deployment-url }}"
          echo "Deployment Name: ${{ steps.prepare.outputs.deployment-name }}"
          if [ -z "${{ steps.prepare.outputs.deployment-name }}" ]; then
            echo "ERROR: deployment-name is empty"
            exit 1
          fi

      # Test preview-deploy action
      - name: Preview Deploy
        id: deploy
        uses: ./preview-deploy
        with:
          cloudflare-api-token: ${{ steps.load-secrets.outputs.cloudflare-api-token }}
          cloudflare-account-id: ${{ steps.load-secrets.outputs.cloudflare-account-id }}
          worker-name: 'cf-actions-e2e-pr-{pr-number}'
          environment: preview
          domain: harunonsystem.workers.dev
          wrangler-toml-path: ./e2e/wrangler.toml
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify deploy outputs
        run: |
          echo "Deployment URL: ${{ steps.deploy.outputs.deployment-url }}"
          echo "Deployment Name: ${{ steps.deploy.outputs.deployment-name }}"
          echo "Deployment Success: ${{ steps.deploy.outputs.deployment-success }}"
          if [ "${{ steps.deploy.outputs.deployment-success }}" != "true" ]; then
            echo "ERROR: deployment-success is not true"
            exit 1
          fi

      # Verify the worker is actually running
      - name: Verify worker is accessible
        run: |
          sleep 5
          RESPONSE=$(curl -sf "${{ steps.deploy.outputs.deployment-url }}" || echo "FAILED")
          echo "Response: $RESPONSE"
          if [ "$RESPONSE" = "FAILED" ]; then
            echo "ERROR: Worker is not accessible"
            exit 1
          fi
          # Verify it's our worker
          echo "$RESPONSE" | jq -e '.status == "ok"'

  e2e-cleanup:
    name: E2E - Cleanup
    runs-on: ubuntu-latest
    needs: e2e-preview-deploy
    if: always() && (github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository)

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Load secrets
        id: load-secrets
        uses: ./.github/actions/load-secrets
        with:
          op-service-account-token: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}

      - name: Setup
        uses: ./.github/actions/setup
        with:
          node-version: '20'

      - name: Build actions
        run: pnpm build

      # Test cleanup action (dry-run first)
      - name: Cleanup (dry-run)
        id: cleanup-dry
        uses: ./cleanup
        with:
          cloudflare-api-token: ${{ steps.load-secrets.outputs.cloudflare-api-token }}
          cloudflare-account-id: ${{ steps.load-secrets.outputs.cloudflare-account-id }}
          worker-names: 'cf-actions-e2e-pr-${{ github.event.pull_request.number || 0 }}'
          dry-run: 'true'

      - name: Verify dry-run outputs
        run: |
          echo "Dry-run results: ${{ steps.cleanup-dry.outputs.dry-run-results }}"
          echo "Deleted count: ${{ steps.cleanup-dry.outputs.deleted-count }}"
          # In dry-run, deleted-count should be 0
          if [ "${{ steps.cleanup-dry.outputs.deleted-count }}" != "0" ]; then
            echo "ERROR: deleted-count should be 0 in dry-run mode"
            exit 1
          fi

      # Actual cleanup
      - name: Cleanup (actual)
        id: cleanup
        uses: ./cleanup
        with:
          cloudflare-api-token: ${{ steps.load-secrets.outputs.cloudflare-api-token }}
          cloudflare-account-id: ${{ steps.load-secrets.outputs.cloudflare-account-id }}
          worker-names: 'cf-actions-e2e-pr-${{ github.event.pull_request.number || 0 }}'
          dry-run: 'false'

      - name: Verify cleanup outputs
        run: |
          echo "Deleted workers: ${{ steps.cleanup.outputs.deleted-workers }}"
          echo "Deleted count: ${{ steps.cleanup.outputs.deleted-count }}"

      - name: Verify worker is deleted
        run: |
          sleep 5
          WORKER_NAME="cf-actions-e2e-pr-${{ github.event.pull_request.number || 0 }}"
          URL="https://${WORKER_NAME}.harunonsystem.workers.dev"
          HTTP_CODE=$(curl -sf -o /dev/null -w "%{http_code}" "$URL" || echo "000")
          echo "HTTP Code: $HTTP_CODE"
          if [ "$HTTP_CODE" = "200" ]; then
            echo "ERROR: Worker still accessible after cleanup"
            exit 1
          fi
          echo "Worker successfully deleted (HTTP $HTTP_CODE)"

  e2e-pr-comment:
    name: E2E - PR Comment
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup
        uses: ./.github/actions/setup
        with:
          node-version: '20'

      - name: Build actions
        run: pnpm build

      # Test pr-comment action
      - name: PR Comment
        id: comment
        uses: ./pr-comment
        with:
          deployment-url: 'https://e2e-test-worker-from-pr-comment.harunonsystem.workers.dev'
          deployment-success: 'true'
          deployment-name: 'e2e-test-worker-from-pr-comment'
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify comment outputs
        run: |
          echo "Comment ID: ${{ steps.comment.outputs.comment-id }}"
          if [ -z "${{ steps.comment.outputs.comment-id }}" ]; then
            echo "ERROR: comment-id is empty"
            exit 1
          fi
