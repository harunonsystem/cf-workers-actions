---
name: Test Cloudflare Actions
on:
  workflow_dispatch: {}
  pull_request:
    paths:
      - 'src/**'
      - 'tests/**'
      - '.github/workflows/**'

jobs:
  test-deploy:
    runs-on: ubuntu-latest
    environment: testing
    outputs:
      worker-url: ${{ steps.deploy.outputs.url }}
      worker-name: ${{ steps.deploy.outputs.worker-name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Load secrets from 1Password
        id: load-secrets
        uses: ./.github/actions/load-1password-secrets
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}

      - name: Deploy to Cloudflare Workers
        id: deploy
        uses: ./deploy
        with:
          cloudflare-api-token: ${{ steps.load-secrets.outputs.CLOUDFLARE_API_TOKEN }}
          cloudflare-account-id: ${{ steps.load-secrets.outputs.CLOUDFLARE_ACCOUNT_ID }}
          environment: preview
          worker-name-pattern: 'test-pr-{pr_number}'
          script-path: 'index.js'
          vars: '{"NODE_ENV": "preview", "DEBUG": "true"}'
          secrets: '{"API_KEY": "test-key"}'

  test-comment:
    runs-on: ubuntu-latest
    needs: test-deploy
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Comment on PR
        uses: ./comment
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deployment-url: ${{ needs.test-deploy.outputs.worker-url }}
          deployment-status: 'success'
          worker-name: ${{ needs.test-deploy.outputs.worker-name }}
          custom-message: 'Test deployment completed successfully!'

  test-cleanup:
    runs-on: ubuntu-latest
    environment: testing
    needs: [test-deploy]
    if: always() && github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Load secrets from 1Password
        id: load-secrets
        uses: ./.github/actions/load-1password-secrets
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}

      - name: Cleanup old workers
        uses: ./cleanup
        with:
          cloudflare-api-token: ${{ steps.load-secrets.outputs.CLOUDFLARE_API_TOKEN }}
          cloudflare-account-id: ${{ steps.load-secrets.outputs.CLOUDFLARE_ACCOUNT_ID }}
          worker-pattern: 'test-pr-*'
          exclude-pattern: '*-production'
          max-age-days: 7
          dry-run: 'false'
          confirm-deletion: 'yes'
