---
name: 'Cloudflare Workers Deploy'
description: 'Deploy workers with automatic wrangler.toml patching for dynamic worker names'
author: 'harunonsystem'

branding:
  icon: 'upload-cloud'
  color: 'orange'

inputs:
  environment:
    description: 'Deployment environment (any string accepted - maps to wrangler.toml [env.{environment}] section)'
    required: true
    default: 'preview'

  worker-name:
    description: 'Worker name to deploy (automatically patches wrangler.toml for non-production environments)'
    required: false

  worker-name-pattern:
    description: 'Worker name pattern. Supports placeholders: {pr_number} for PR number, {branch} for branch name, * for wildcard. Names are automatically sanitized (lowercase, non-alphanumeric â†’ hyphens, max 63 chars). If pattern contains {pr_number} or is a PR event, will automatically patch wrangler.toml.'
    required: false

  subdomain:
    description: 'Custom subdomain for worker URLs (e.g., "yourdomain" for yourdomain.workers.dev)'
    required: false

  force-preview:
    description: 'Force preview mode (patch wrangler.toml even without {pr_number} pattern)'
    required: false
    default: 'false'

  api-token:
    description: 'Cloudflare API Token (requires Workers:Edit permissions)'
    required: true

  account-id:
    description: 'Cloudflare Account ID (found in dashboard sidebar)'
    required: false

  secrets:
    description: 'Worker secrets in JSON format (e.g., {"API_KEY": "secret-value", "DB_URL": "connection-string"})'
    required: false
    default: '{}'

  deploy-command:
    description: 'Wrangler deploy command (default: "deploy")'
    required: false
    default: 'deploy'

  wrangler-file:
    description: 'Path to wrangler.toml file (default: "wrangler.toml")'
    required: false
    default: 'wrangler.toml'

  workflow-mode:
    description: 'Deployment workflow mode: auto (detect from branch), gitflow (release/* and hotfix/* branches), githubflow (main/master only)'
    required: false
    default: 'auto'

  exclude-branches:
    description: 'Comma-separated or JSON array of branch names to exclude from deployment (e.g., "dependabot,staging" or ["bot","test"])'
    required: false
    default: ''

  release-branch-pattern:
    description: 'Pattern for release branches (e.g., "release/" for release/* branches)'
    required: false
    default: 'release/'

outputs:
  worker-url:
    description: 'Deployed worker URL (generated from worker-name and subdomain, or extracted from deploy output)'

  worker-name:
    description: 'Deployed worker name (generated from pattern or provided explicitly)'

  success:
    description: 'Deployment success status (true/false)'

  error-message:
    description: 'Error message if deployment failed'

runs:
  using: 'node20'
  main: '../dist/deploy/index.js'
