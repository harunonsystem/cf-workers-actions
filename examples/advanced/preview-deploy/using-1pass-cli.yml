name: Advanced Preview Deployment (Using 1Password CLI)

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to deploy (leave empty for current branch)'
        required: false
        type: string
      environment_type:
        description: 'Environment type for deployment'
        required: false
        default: 'preview'
        type: choice
        options:
          - preview
          - staging
          - development
      custom_worker_name:
        description: 'Custom worker name (overrides pattern)'
        required: false
        type: string
      skip_build:
        description: 'Skip build step (for testing deployments)'
        required: false
        default: false
        type: boolean
      deployment_config:
        description: 'Deployment configuration preset'
        required: false
        default: 'standard'
        type: choice
        options:
          - minimal
          - standard
          - performance
          - debug
          - security-enhanced
      vault_path_override:
        description: 'Override 1Password vault path (advanced users only)'
        required: false
        type: string
      enable_monitoring:
        description: 'Enable enhanced monitoring and alerting'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  pull-requests: write
  deployments: write

jobs:
  setup-credentials:
    runs-on: ubuntu-latest
    outputs:
      api-token: ${{ steps.load-secrets.outputs.CLOUDFLARE_API_TOKEN }}
      account-id: ${{ steps.load-secrets.outputs.CLOUDFLARE_ACCOUNT_ID }}
      vault-loaded: 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install 1Password CLI
        uses: 1password/install-cli-action@v1

      - name: Load Cloudflare credentials from 1Password
        id: load-secrets
        uses: 1password/load-secrets-action@v1
        with:
          export-env: true
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          CLOUDFLARE_API_TOKEN: ${{ github.event.inputs.vault_path_override || 'op://cloudflare/preview/cloudflare-api-token' }}
          CLOUDFLARE_ACCOUNT_ID: ${{ github.event.inputs.vault_path_override && format('op://cloudflare/{0}/cloudflare-account-id', github.event.inputs.vault_path_override) || 'op://cloudflare/preview/cloudflare-account-id' }}

  validation:
    runs-on: ubuntu-latest
    needs: setup-credentials
    outputs:
      should_deploy: ${{ steps.validate.outputs.should_deploy }}
      worker_name: ${{ steps.validate.outputs.worker_name }}
      environment_type: ${{ steps.validate.outputs.environment_type }}
      security_level: ${{ steps.validate.outputs.security_level }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Advanced deployment validation
        id: validate
        run: |
          # Enhanced validation with security considerations
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # Check if PR is from a fork (security consideration)
            if [ "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ]; then
              echo "âš ï¸ Fork detected - applying restricted deployment mode"
              echo "security_level=restricted" >> $GITHUB_OUTPUT
            else
              echo "security_level=standard" >> $GITHUB_OUTPUT
            fi
            
            # Check if PR is draft
            if [ "${{ github.event.pull_request.draft }}" == "true" ]; then
              echo "should_deploy=false" >> $GITHUB_OUTPUT
              echo "Draft PR detected, skipping deployment"
              exit 0
            fi
            
            # Check for skip deployment label
            if echo "${{ toJson(github.event.pull_request.labels.*.name) }}" | grep -q "skip-deploy"; then
              echo "should_deploy=false" >> $GITHUB_OUTPUT
              echo "Skip deploy label found, skipping deployment"
              exit 0
            fi
            
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "environment_type=preview" >> $GITHUB_OUTPUT
            echo "worker_name=secure-app-pr-${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "security_level=enhanced" >> $GITHUB_OUTPUT
            echo "environment_type=${{ github.event.inputs.environment_type || 'preview' }}" >> $GITHUB_OUTPUT
            
            if [ -n "${{ github.event.inputs.custom_worker_name }}" ]; then
              echo "worker_name=${{ github.event.inputs.custom_worker_name }}" >> $GITHUB_OUTPUT
            elif [ -n "${{ github.event.inputs.pr_number }}" ]; then
              echo "worker_name=secure-app-pr-${{ github.event.inputs.pr_number }}" >> $GITHUB_OUTPUT
            else
              echo "worker_name=secure-app-branch-$(echo ${{ github.ref_name }} | sed 's/[^a-zA-Z0-9-]/-/g')" >> $GITHUB_OUTPUT
            fi
          fi

  build:
    runs-on: ubuntu-latest
    needs: [setup-credentials, validation]
    if: needs.validation.outputs.should_deploy == 'true' && github.event.inputs.skip_build != 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install 1Password CLI
        uses: 1password/install-cli-action@v1

      - name: Load build secrets from 1Password
        uses: 1password/load-secrets-action@v1
        with:
          export-env: true
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          NODE_AUTH_TOKEN: 'op://build-secrets/npm/auth-token'
          BUILD_API_KEY: 'op://build-secrets/api/build-key'

      - name: Setup Node.js with enhanced caching
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies with security audit
        run: |
          npm ci
          npm audit --audit-level moderate

      - name: Run comprehensive tests
        run: |
          npm test
          npm run test:integration
          npm run test:security

      - name: Advanced linting and security checks
        run: |
          npm run lint
          npm run lint:security
          npx audit-ci --config .audit-ci.json

      - name: Build with environment-specific optimization
        run: |
          case "${{ needs.validation.outputs.environment_type }}" in
            "preview")
              npm run build:preview -- --optimize
              ;;
            "staging")
              npm run build:staging -- --optimize --security-enhanced
              ;;
            "development")
              npm run build:dev -- --debug --source-maps
              ;;
            *)
              npm run build -- --optimize
              ;;
          esac

      - name: Generate build manifest
        run: |
          cat > build-manifest.json << EOF
          {
            "build_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit_sha": "${{ github.sha }}",
            "environment": "${{ needs.validation.outputs.environment_type }}",
            "config": "${{ github.event.inputs.deployment_config || 'standard' }}",
            "security_level": "${{ needs.validation.outputs.security_level }}",
            "node_version": "$(node --version)",
            "npm_version": "$(npm --version)"
          }
          EOF

      - name: Upload build artifacts with manifest
        uses: actions/upload-artifact@v4
        with:
          name: secure-build-artifacts
          path: |
            dist/
            build-manifest.json
          retention-days: 7

  deploy:
    runs-on: ubuntu-latest
    needs: [setup-credentials, validation, build]
    if: always() && needs.validation.outputs.should_deploy == 'true' && (needs.build.result == 'success' || needs.build.result == 'skipped')
    environment: ${{ needs.validation.outputs.environment_type }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install 1Password CLI
        uses: 1password/install-cli-action@v1

      - name: Download build artifacts
        if: github.event.inputs.skip_build != 'true'
        uses: actions/download-artifact@v4
        with:
          name: secure-build-artifacts
          path: ./

      - name: Load environment secrets from 1Password
        id: env-secrets
        uses: 1password/load-secrets-action@v1
        with:
          export-env: true
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          # Dynamic secret loading based on environment
          DATABASE_URL: ${{ needs.validation.outputs.environment_type == 'staging' && 'op://environments/staging/database-url' || needs.validation.outputs.environment_type == 'development' && 'op://environments/development/database-url' || 'op://environments/preview/database-url' }}
          API_KEY: ${{ needs.validation.outputs.environment_type == 'staging' && 'op://environments/staging/api-key' || needs.validation.outputs.environment_type == 'development' && 'op://environments/development/api-key' || 'op://environments/preview/api-key' }}
          REDIS_URL: ${{ needs.validation.outputs.environment_type != 'development' && 'op://environments/shared/redis-url' || '' }}
          MONITORING_KEY: ${{ github.event.inputs.enable_monitoring == 'true' && 'op://monitoring/keys/deployment-key' || '' }}

      - name: Prepare advanced deployment configuration
        id: config
        run: |
          # Base configuration
          case "${{ github.event.inputs.deployment_config || 'standard' }}" in
            "minimal")
              BASE_CONFIG='{"NODE_ENV": "preview", "LOG_LEVEL": "error"}'
              ;;
            "performance")
              BASE_CONFIG='{"NODE_ENV": "production", "LOG_LEVEL": "warn", "CACHE_ENABLED": "true", "COMPRESSION": "true", "CDN_ENABLED": "true"}'
              ;;
            "debug")
              BASE_CONFIG='{"NODE_ENV": "development", "LOG_LEVEL": "debug", "DEBUG": "true", "SOURCE_MAPS": "true"}'
              ;;
            "security-enhanced")
              BASE_CONFIG='{"NODE_ENV": "production", "LOG_LEVEL": "warn", "SECURITY_HEADERS": "true", "RATE_LIMITING": "true", "IP_WHITELIST": "enabled"}'
              ;;
            *)
              BASE_CONFIG='{"NODE_ENV": "preview", "LOG_LEVEL": "info"}'
              ;;
          esac

          # Add environment-specific secrets
          SECRETS=$(echo $BASE_CONFIG | jq --arg db "$DATABASE_URL" --arg api "$API_KEY" --arg redis "$REDIS_URL" '. + {"DATABASE_URL": $db, "API_KEY": $api} + (if $redis != "" then {"REDIS_URL": $redis} else {} end)')

          # Add monitoring if enabled
          if [ "${{ github.event.inputs.enable_monitoring }}" == "true" ] && [ -n "$MONITORING_KEY" ]; then
            SECRETS=$(echo $SECRETS | jq --arg key "$MONITORING_KEY" '. + {"MONITORING_KEY": $key, "MONITORING_ENABLED": "true"}')
          fi

          # Add security context
          SECRETS=$(echo $SECRETS | jq --arg level "${{ needs.validation.outputs.security_level }}" '. + {"SECURITY_LEVEL": $level, "DEPLOYMENT_ID": "${{ github.run_id }}"}')

          echo "secrets=$SECRETS" >> $GITHUB_OUTPUT

      - name: Advanced Deploy with 1Password Security
        uses: harunonsystem/cloudflare-actions/deploy@v1
        with:
          environment: ${{ needs.validation.outputs.environment_type }}
          worker-name-pattern: ${{ needs.validation.outputs.worker_name }}
          cloudflare-api-token: ${{ needs.setup-credentials.outputs.api-token }}
          cloudflare-account-id: ${{ needs.setup-credentials.outputs.account-id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          secrets: ${{ steps.config.outputs.secrets }}

      - name: Create secure deployment artifact
        run: |
          cat > secure-deployment-info.json << EOF
          {
            "deployment_id": "${{ github.run_id }}",
            "worker_name": "${{ needs.validation.outputs.worker_name }}",
            "environment": "${{ needs.validation.outputs.environment_type }}",
            "configuration": "${{ github.event.inputs.deployment_config || 'standard' }}",
            "security_level": "${{ needs.validation.outputs.security_level }}",
            "pr_number": "${{ github.event.pull_request.number || github.event.inputs.pr_number }}",
            "commit_sha": "${{ github.sha }}",
            "vault_integration": true,
            "monitoring_enabled": "${{ github.event.inputs.enable_monitoring == 'true' }}",
            "deployed_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "security_compliance": {
              "credentials_in_vault": true,
              "security_scanning": true,
              "audit_logging": true
            }
          }
          EOF

      - name: Upload secure deployment info
        uses: actions/upload-artifact@v4
        with:
          name: secure-deployment-info
          path: secure-deployment-info.json
          retention-days: 90

  security-audit:
    runs-on: ubuntu-latest
    needs: [validation, deploy]
    if: always() && needs.deploy.result == 'success' && needs.validation.outputs.security_level != 'restricted'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install 1Password CLI
        uses: 1password/install-cli-action@v1

      - name: Security health check
        run: |
          WORKER_URL="https://${{ needs.validation.outputs.worker_name }}.your-domain.workers.dev"

          echo "ðŸ”’ Performing security health check on: $WORKER_URL"

          # Security headers check
          HEADERS_RESPONSE=$(curl -I -s --max-time 30 "$WORKER_URL" || echo "failed")
          if echo "$HEADERS_RESPONSE" | grep -i "strict-transport-security\|content-security-policy\|x-frame-options" > /dev/null; then
            echo "âœ… Security headers present"
          else
            echo "âš ï¸ Some security headers missing"
          fi

          # SSL/TLS check
          if curl -s --max-time 10 -I "$WORKER_URL" | head -1 | grep -q "200"; then
            echo "âœ… HTTPS connectivity verified"
          else
            echo "âš ï¸ HTTPS connectivity issue"
          fi

      - name: Compliance reporting
        run: |
          echo "ðŸ“‹ Security Compliance Report" >> compliance-report.md
          echo "=============================" >> compliance-report.md
          echo "" >> compliance-report.md
          echo "**Deployment:** ${{ needs.validation.outputs.worker_name }}" >> compliance-report.md
          echo "**Environment:** ${{ needs.validation.outputs.environment_type }}" >> compliance-report.md
          echo "**Security Level:** ${{ needs.validation.outputs.security_level }}" >> compliance-report.md
          echo "**Vault Integration:** âœ… Enabled" >> compliance-report.md
          echo "**Audit Timestamp:** $(date -u)" >> compliance-report.md

      - name: Upload compliance report
        uses: actions/upload-artifact@v4
        with:
          name: security-compliance-report
          path: compliance-report.md
          retention-days: 180

  comprehensive-summary:
    runs-on: ubuntu-latest
    needs: [setup-credentials, validation, build, deploy, security-audit]
    if: always()

    steps:
      - name: Create comprehensive deployment summary
        run: |
          echo "## ðŸ” Advanced Secure Preview Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "**Worker Name:** ${{ needs.validation.outputs.worker_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ needs.validation.outputs.environment_type }}" >> $GITHUB_STEP_SUMMARY
          echo "**Security Level:** ${{ needs.validation.outputs.security_level }}" >> $GITHUB_STEP_SUMMARY
          echo "**Configuration:** ${{ github.event.inputs.deployment_config || 'standard' }}" >> $GITHUB_STEP_SUMMARY
          echo "**1Password Integration:** âœ… Active" >> $GITHUB_STEP_SUMMARY
          echo "**Monitoring:** ${{ github.event.inputs.enable_monitoring == 'true' && 'âœ… Enabled' || 'âŒ Disabled' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed at:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Pipeline Status" >> $GITHUB_STEP_SUMMARY
          echo "**Credentials Setup:** ${{ needs.setup-credentials.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Validation:** ${{ needs.validation.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build:** ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deploy:** ${{ needs.deploy.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Security Audit:** ${{ needs.security-audit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ Advanced Features Used" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… 1Password Service Account integration" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Multi-job secure credential sharing" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Environment-specific secret management" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Security-enhanced deployment configurations" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Fork detection and restricted mode" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Advanced security scanning and auditing" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Comprehensive compliance reporting" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Enhanced monitoring integration" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Build manifest and artifact management" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”’ Security Features" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Zero credentials in workflow files" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… 1Password vault integration" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Dynamic vault path configuration" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Security header validation" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… HTTPS/TLS verification" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Compliance audit trail" >> $GITHUB_STEP_SUMMARY
